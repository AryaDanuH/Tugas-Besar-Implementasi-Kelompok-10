<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Books - LibMatch</title>
    <link rel="stylesheet" href="/FrontEnd/css/style.css">
    <style>
        .tabs-container {
            display: flex;
            gap: 30px;
            padding: 20px 40px;
            border-bottom: 1px solid #e0e0e0;
            background: white;
        }

        .tab {
            cursor: pointer;
            font-size: 14px;
            color: #999;
            padding-bottom: 15px;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #333;
            border-bottom-color: #7c5cdb;
        }

        .books-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 30px;
            padding: 40px;
            background: white;
        }

        .book-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            position: relative;
        }

        .book-cover {
            width: 150px;
            height: 200px;
            background: #f5f5f5;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 15px;
            position: relative;
        }

        .book-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .book-cover.grayed {
            filter: grayscale(100%) opacity(0.5);
        }

        .book-title {
            font-weight: 600;
            font-size: 14px;
            color: #333;
            margin-bottom: 5px;
        }

        .book-author {
            font-size: 12px;
            color: #999;
        }

        .book-status {
            font-size: 11px;
            margin-top: 5px;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .status-icon {
            width: 16px;
            height: 16px;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-accepted {
            background: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .add-book-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 150px;
            height: 200px;
            background: #e8e8e8;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 48px;
            color: #999;
            transition: all 0.3s ease;
        }

        .add-book-btn:hover {
            background: #d0d0d0;
        }

        .empty-state {
            text-align: center;
            padding: 60px 40px;
            color: #999;
            font-size: 16px;
        }

        @media (max-width: 1200px) {
            .books-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .books-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
                padding: 20px;
            }

            .tabs-container {
                padding: 15px 20px;
            }
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: grid;
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header class="site-header">
        <div class="header-top">
            <div class="logo">LibMatch</div>
            <div class="right-actions">
                <a href="/FrontEnd/cart.html" class="cart-icon-link" style="margin-right: 15px;">
                    <img src="/FrontEnd/images/cart.png" alt="Cart" style="width: 28px; height: 28px; cursor: pointer;">
                </a>
                <a href="/FrontEnd/profile.html" class="profile-avatar-link">
                    <!-- Replaced initial-avatar div with img tag for profile picture -->
                    <img id="userAvatar" class="profile-avatar-img" src="/FrontEnd/images/placeholder-profile.png" alt="Profile">
                </a>
                <button class="logout-btn" onclick="logout()" title="Logout">Logout</button>
                <span class="lang-text">EN</span>
            </div>
        </div>

        <nav class="main-nav header-nav">
            <a href="/FrontEnd/dashboard-logged-in.html">Home</a>
            <a href="/FrontEnd/top-seller.html">Bestseller</a>
            <a href="/FrontEnd/select-categories.html">Category</a>
            <a href="/FrontEnd/location.html">Locations</a>
            <a href="/FrontEnd/your-books.html" class="active">My Books</a>
        </nav>
    </header>

    <main class="main-content" style="background: white; min-height: 80vh;">
        <div style="padding: 40px;">
            <div class="tabs-container">
                <div class="tab active" onclick="switchBookTab('mybooks')">My Books</div>
                <div class="tab" onclick="switchBookTab('loaning')">Books I'm Loaning</div>
                <div class="tab" onclick="switchBookTab('loaned')">Books I've Loaned</div>
            </div>

            <div style="display: flex; justify-content: center; margin: 30px 40px 20px;">
                <div class="search-wrap header-search">
                    <input type="text" id="searchInput" placeholder="Search by author, title, or name..." oninput="handleSearch()" />
                </div>
            </div>

            <div id="mybooksTab" class="tab-content active">
                <h1 style="margin-bottom: 30px; margin-left: 40px; font-size: 28px; color: #333;">My Books</h1>
                <div class="books-grid" id="booksContainer">
                    <p class="empty-state">Loading your books...</p>
                </div>
                <div style="text-align: center; margin-top: 40px;">
                    <a href="/FrontEnd/upload-book.html" class="add-book-btn" style="width: auto; height: auto; padding: 15px 30px; text-decoration: none; background: #7c5cdb; color: white; border-radius: 8px; font-size: 16px;">
                        + Add New Book
                    </a>
                </div>
            </div>

            <div id="loaningTab" class="tab-content">
                <h1 style="margin-bottom: 30px; margin-left: 40px; font-size: 28px; color: #333;">Books I'm Loaning</h1>
                <div class="books-grid" id="loaningContainer">
                    <p class="empty-state">You haven't borrowed any books yet.</p>
                </div>
            </div>

            <div id="loanedTab" class="tab-content">
                <h1 style="margin-bottom: 30px; margin-left: 40px; font-size: 28px; color: #333;">Books I've Loaned</h1>
                <div class="books-grid" id="loanedContainer">
                    <p class="empty-state">No loan history yet.</p>
                </div>
            </div>
        </div>
    </main>

    <footer class="site-footer">
        <nav class="footer-nav">
            <a href="/FrontEnd/about.html">About</a> | 
            <a href="/FrontEnd/help.html">Help</a> | 
            <a href="/FrontEnd/terms.html">Terms</a> | 
            <a href="/FrontEnd/privacy.html">Privacy</a> |
            <a href="/FrontEnd/contact.html">Contact</a> 
        </nav>
        <p>&copy; 2025 LibMatch. All rights reserved.</p>
    </footer>

    <script src="/FrontEnd/js/auth.js"></script>
    <script>
        let allBooks = [];
        let loaningBooks = [];
        let loanedBooks = [];
        let currentBookTab = 'mybooks';

        function switchBookTab(tab) {
            currentBookTab = tab;
            
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if (tab === 'mybooks') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('mybooksTab').classList.add('active');
            } else if (tab === 'loaning') {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('loaningTab').classList.add('active');
                loadLoaningBooks();
            } else if (tab === 'loaned') {
                document.querySelectorAll('.tab')[2].classList.add('active');
                document.getElementById('loanedTab').classList.add('active');
                loadLoanedBooks();
            }
        }

        function initPage() {
            const user = getCurrentUser()
            if (!user || !user.user_id) {
                window.location.href = "/FrontEnd/login.html"
                return
            }

            const avatar = document.getElementById("userAvatar")
            if (avatar && user.name) {
                avatar.alt = user.name.charAt(0).toUpperCase()
            }

            loadUserBooks(user.user_id)
            
            const urlParams = new URLSearchParams(window.location.search);
            const tab = urlParams.get('tab');
            if (tab) {
                switchBookTab(tab);
            }
        }

        async function loadUserBooks(userId) {
            try {
                const response = await fetch(`/api/users/${userId}/books`)
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to fetch books: ${response.status} ${errorText}`)
                }

                const books = await response.json()
                allBooks = books || [];
                displayBooks(allBooks);
            } catch (error) {
                console.error('Error loading books:', error)
                const container = document.getElementById("booksContainer")
                container.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;">Error loading your books. Please try again.</div>'
            }
        }

        async function loadLoaningBooks() {
            const user = getCurrentUser();
            if (!user || !user.user_id) return;

            try {
                const response = await fetch(`/api/users/${user.user_id}/borrowed-books`);
                if (!response.ok) {
                    throw new Error('Failed to fetch borrowed books');
                }

                const borrowedBooks = await response.json();
                
                loaningBooks = borrowedBooks.filter(book => book.status === 'active');
                displayLoaningBooks();
            } catch (error) {
                console.error('Error loading loaning books:', error);
                document.getElementById('loaningContainer').innerHTML = 
                    '<div class="empty-state" style="grid-column: 1/-1;">Error loading borrowed books. Please try again.</div>';
            }
        }

        async function loadLoanedBooks() {
            const user = getCurrentUser();
            if (!user || !user.user_id) return;

            try {
                const response = await fetch(`/api/users/${user.user_id}/borrowed-books`);
                if (!response.ok) {
                    throw new Error('Failed to fetch borrowed books');
                }

                const borrowedBooks = await response.json();
                loanedBooks = borrowedBooks.filter(book => book.status === 'returned');
                await checkReviewsForBooks();
                displayLoanedBooks();
            } catch (error) {
                console.error('Error loading loaned books:', error);
                document.getElementById('loanedContainer').innerHTML = 
                    '<div class="empty-state" style="grid-column: 1/-1;">Error loading loan history. Please try again.</div>';
            }
        }

        async function checkReviewsForBooks() {
            const user = getCurrentUser();
            if (!user || !user.user_id) return;

            for (let book of loanedBooks) {
                try {
                    const response = await fetch(`${API_URL}/reviews/book/${book.book_id}`);
                    if (response.ok) {
                        const reviews = await response.json();
                        book.hasUserReview = reviews.some(review => review.user_id === user.user_id);
                    } else {
                        book.hasUserReview = false;
                    }
                } catch (error) {
                    console.error('Error checking reviews:', error);
                    book.hasUserReview = false;
                }
            }
        }

        function displayLoaningBooks() {
            const container = document.getElementById("loaningContainer");
            
            if (loaningBooks.length === 0) {
                container.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;">You haven\'t borrowed any books yet.</div>';
                return;
            }

            container.innerHTML = "";
            loaningBooks.forEach(book => {
                const bookCard = document.createElement("div");
                bookCard.className = "book-item";
                bookCard.onclick = () => {
                    window.location.href = `/FrontEnd/borrowed-book-detail.html?borrow_id=${book.borrow_id}`;
                };
                
                bookCard.innerHTML = `
                    <div class="book-cover">
                        <img src="${book.cover_image || '/FrontEnd/images/book-cover.png'}" alt="${book.title}">
                    </div>
                    <div class="book-title">${book.title}</div>
                    <div class="book-author">${book.author}</div>
                    <div style="font-size: 11px; color: #7c5cdb; margin-top: 5px;">Due: ${formatReturnDate(book.due_date)}</div>
                `;
                container.appendChild(bookCard);
            });
        }

        function displayLoanedBooks() {
            const container = document.getElementById("loanedContainer");
            
            if (loanedBooks.length === 0) {
                container.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;">No loan history yet.</div>';
                return;
            }

            container.innerHTML = "";
            loanedBooks.forEach(book => {
                const bookCard = document.createElement("div");
                bookCard.className = "book-item";
                
                const returnDateText = formatReturnDate(book.return_date);
                
                const reviewButtonHTML = !book.hasUserReview ? `
                    <button onclick="event.stopPropagation(); window.location.href='/FrontEnd/submit-review.html?book_id=${book.book_id}&borrow_id=${book.borrow_id}';" 
                            style="margin-top: 10px; padding: 8px 16px; background: #7c5cdb; color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; transition: background 0.3s ease;"
                            onmouseover="this.style.background='#6247b8'" 
                            onmouseout="this.style.background='#7c5cdb'">
                        Write Review
                    </button>
                ` : '';
                
                bookCard.innerHTML = `
                    <div class="book-cover grayed">
                        <img src="${book.cover_image || '/FrontEnd/images/book-cover.png'}" alt="${book.title}">
                    </div>
                    <div class="book-title">${book.title}</div>
                    <div class="book-author">${book.author}</div>
                    <div style="font-size: 11px; color: #999; margin-top: 5px;">Returned: ${returnDateText}</div>
                    ${reviewButtonHTML}
                `;
                container.appendChild(bookCard);
            });
        }

        function displayBooks(books) {
            const container = document.getElementById("booksContainer")

            if (!books || books.length === 0) {
                container.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;">You haven\'t uploaded any books yet. <a href="/FrontEnd/upload-book.html" style="color: #7c5cdb; text-decoration: underline;">Upload one now!</a></div>'
                return
            }

            container.innerHTML = ""

            books.forEach(book => {
                const bookCard = document.createElement("div")
                bookCard.className = "book-item"
                bookCard.style.cursor = "pointer"
                bookCard.onclick = () => {
                    window.location.href = `/FrontEnd/book-detail.html?id=${book.book_id}`
                }
                
                let statusBadge = '/FrontEnd/images/Pending.png'
                let statusText = 'Pending'
                let statusClass = 'status-pending'
                
                if (book.status === 'accepted') {
                    statusBadge = '/FrontEnd/images/Accepted.png'
                    statusText = 'Accepted'
                    statusClass = 'status-accepted'
                } else if (book.status === 'rejected') {
                    statusBadge = '/FrontEnd/images/Rejected.png'
                    statusText = 'Rejected'
                    statusClass = 'status-rejected'
                }
                
                bookCard.innerHTML = `
                    <div class="book-cover">
                        <img src="${book.cover_image || '/FrontEnd/images/book-cover.png'}" alt="${book.title}" onerror="this.src='/FrontEnd/images/placeholder-Image.png'">
                    </div>
                    <div class="book-title">${book.title}</div>
                    <div class="book-author">${book.author}</div>
                    <div class="book-status ${statusClass}">
                        <img src="${statusBadge}" class="status-icon" alt="${statusText}">
                        ${statusText}
                    </div>
                `
                container.appendChild(bookCard)
            })
        }

        function handleSearch() {
            const searchInput = document.getElementById('searchInput');
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            if (!searchTerm) {
                if (currentBookTab === 'mybooks') displayBooks(allBooks);
                else if (currentBookTab === 'loaning') displayLoaningBooks();
                else if (currentBookTab === 'loaned') displayLoanedBooks();
                return;
            }
            
            let booksToFilter = currentBookTab === 'mybooks' ? allBooks : 
                               currentBookTab === 'loaning' ? loaningBooks : loanedBooks;
            
            const filteredBooks = booksToFilter.filter(book => {
                return (
                    (book.title && book.title.toLowerCase().includes(searchTerm)) ||
                    (book.author && book.author.toLowerCase().includes(searchTerm)) ||
                    (book.category_name && book.category_name.toLowerCase().includes(searchTerm))
                );
            });
            
            if (filteredBooks.length === 0) {
                const containerId = currentBookTab === 'mybooks' ? 'booksContainer' :
                                   currentBookTab === 'loaning' ? 'loaningContainer' : 'loanedContainer';
                document.getElementById(containerId).innerHTML = '<div class="empty-state" style="grid-column: 1/-1;">No books found matching your search.</div>';
            } else {
                if (currentBookTab === 'mybooks') displayBooks(filteredBooks);
                else if (currentBookTab === 'loaning') {
                    loaningBooks = filteredBooks;
                    displayLoaningBooks();
                }
                else {
                    loanedBooks = filteredBooks;
                    displayLoanedBooks();
                }
            }
        }

        window.addEventListener("load", initPage)

        function formatReturnDate(dateString) {
            console.log('[v0] formatReturnDate input:', dateString, 'type:', typeof dateString);
            
            if (!dateString) return 'Not Returned';
            
            // Handle objects with String property (capitalized)
            if (typeof dateString === 'object' && dateString !== null && dateString.String) {
                const isoString = dateString.String;
                try {
                    const date = new Date(isoString);
                    if (isNaN(date.getTime())) {
                        return 'Invalid Date';
                    }
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                } catch (error) {
                    return 'Invalid Date';
                }
            }
            
            // If it's already a Date object, use it directly
            if (dateString instanceof Date) {
                if (isNaN(dateString.getTime())) {
                    return 'Invalid Date';
                }
                return dateString.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }
            
            // If it's an object (like {_seconds, _nanoseconds} from Firestore or similar), extract timestamp
            if (typeof dateString === 'object') {
                // Handle Firestore Timestamp objects
                if (dateString._seconds !== undefined) {
                    dateString = new Date(dateString._seconds * 1000);
                    return dateString.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                }
                // Handle other timestamp formats
                if (dateString.seconds !== undefined) {
                    dateString = new Date(dateString.seconds * 1000);
                    return dateString.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                }
                // If object has a toDate method (Firestore Timestamp)
                if (typeof dateString.toDate === 'function') {
                    dateString = dateString.toDate();
                    return dateString.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                }
                
                return 'Invalid Date';
            }
            
            try {
                let date;
                
                // Handle various date formats from backend
                if (typeof dateString === 'string' && dateString.includes('T')) {
                    // ISO format: "2025-12-10T00:00:00Z"
                    date = new Date(dateString);
                } else if (typeof dateString === 'string' && dateString.includes('-')) {
                    // SQL DATE format: "2025-12-10"
                    // Add time to avoid timezone issues
                    date = new Date(dateString + 'T00:00:00');
                } else {
                    // Try direct parse
                    date = new Date(dateString);
                }
                
                // Check if date is valid
                if (isNaN(date.getTime())) {
                    return 'Invalid Date';
                }
                
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch (error) {
                return 'Invalid Date';
            }
        }
    </script>
</body>
</html>
