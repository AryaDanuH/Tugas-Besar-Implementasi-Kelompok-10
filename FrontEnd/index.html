<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LibMatch</title>
    <link rel="stylesheet" href="/FrontEnd/css/style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    <!-- HEADER -->
    <header class="site-header">
        <div class="header-top">
            <div class="logo"> LibMatch</div>
            <div class="search-wrap header-search">
                <!-- Added id and event listener for search functionality -->
                <input type="text" id="searchInput" placeholder="Search by author, title, or name..." />
            </div>
            <div class="right-actions">
                <button class="login-btn" onclick="window.location.href='/FrontEnd/login.html'">Login</button>
                <span class="lang-text">EN</span>
            </div>
        </div>
        <nav class="main-nav header-nav">
            <a href="#" data-nav-link="home" class="active">Home</a>
            <a href="/FrontEnd/top-seller.html">Bestseller</a>
            <a href="/FrontEnd/select-categories.html">Category</a>
            <a href="/FrontEnd/location.html">Locations</a>
        </nav>
    </header>

    <!-- HOME FEATURE -->
    <main data-feature="home">
        <!-- BEST SELLER SECTION -->
        <section class="best-seller">
            <div class="best-box">
                <h2>Popular Book</h2>
                <p>Find today's trending books</p>
                <button class="enter-btn" onclick="location.href='/FrontEnd/popular-book.html'">Check it now</button>
            </div>
        </section>

        <!-- BOOK CATEGORIES -->
        <section class="book-section">
            <div class="category-header">
                <h2>Popular now</h2>
                <a href="/FrontEnd/popular-book.html" class="explore-btn">Explore All ></a>
            </div>
            <div class="book-slider" id="popular-books-slider">
                <!-- Books will be loaded dynamically -->
            </div>
        </section>

        <section class="book-section">
            <div class="category-header">
                <h2>Top Seller</h2>
                <a href="/FrontEnd/top-seller.html" class="explore-btn">Explore All ></a>
            </div>
            <div class="book-slider" id="top-borrowed-slider">
                <!-- Books will be loaded dynamically -->
            </div>
        </section>

        <section class="book-section">
            <div class="category-header">
                <h2>New Arrivals</h2>
                <a href="/FrontEnd/all-new-arrivals.html" class="explore-btn">Explore All ></a>
            </div>
            <div class="book-slider" id="new-arrivals-slider">
                <!-- Dynamic content loaded via JavaScript -->
            </div>
        </section>

    </main>

    <!-- BESTSELLER FEATURE -->
    <main data-feature="bestseller" style="display: none;">
        <section class="bestseller-section">
            <div class="category-header">
                <h3>Popular BOOK</h3>
            </div>
            <div class="bestseller-grid" id="bestseller-grid">
                <!-- Dynamic content loaded via JavaScript -->
            </div>
        </section>
    </main>

    <!-- KATEGORI FEATURE -->
    <main data-feature="kategori" style="display: none;">
        <section class="kategori-section">
            <div class="category-header">
                <h3>Kategori Buku</h3>
            </div>
            <div id="categoryList" class="kategori-grid">
                <!-- Dynamic categories loaded via JavaScript -->
            </div>
        </section>
    </main>

    <footer class="site-footer">
        <nav class="footer-nav">
            <a href="/FrontEnd/about.html">About</a> | 
            <a href="/FrontEnd/help.html">Help</a> | 
            <a href="/FrontEnd/terms.html">Terms</a> | 
            <a href="/FrontEnd/privacy.html">Privacy</a> |
            <a href="/FrontEnd/contact.html">Contact</a> 
        </nav>
        <p>&copy; 2025 LibMatch. All rights reserved.</p>
    </footer>

    <!-- FIND STORE FEATURE -->
    <main data-feature="find-store" style="display: none;">
        <section class="find-store-section">
            <div class="find-store-container">
                <div class="find-store-map">
                    <div id="map" style="width: 100%; height: 100%;"></div>
                </div>
                <div class="find-store-list">
                    <h3>Book Locations</h3>
                    <p class="location-text" id="userLocationText">Finding your location...</p>
                    <div id="locationsContainer">
                        <!-- Dynamic location cards loaded via JavaScript -->
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script src="/FrontEnd/js/auth.js"></script>
    <script src="/FrontEnd/js/features.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const user = getCurrentUser();
            if (user) {
                const cartIcon = document.getElementById('cartIconLink');
                if (cartIcon) cartIcon.style.display = 'block';
            }
            
            await loadNewArrivals();
            await loadCategories();
        });

        window.addEventListener('load', async function() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const query = searchInput.value.trim();
                        if (query) {
                            window.location.href = `/FrontEnd/search-results.html?q=${encodeURIComponent(query)}`;
                        }
                    }
                });
            }
            await loadPopularBooks();
            await loadTopBorrowedBooks();
        });

        async function loadNewArrivals() {
            try {
                const response = await fetch(`${API_URL}/books/new-arrivals`);
                if (!response.ok) throw new Error('Failed to fetch new arrivals');
                
                const books = await response.json();
                displayBooksInSlider(books.slice(0, 10), 'new-arrivals-slider');
            } catch (error) {
                console.error('Error loading new arrivals:', error);
            }
        }

        function displayBooksInSlider(books, sliderId) {
            const container = document.getElementById(sliderId);
            if (!container) return;

            container.innerHTML = '';
            
            books.forEach(book => {
                const bookCard = document.createElement('div');
                bookCard.className = 'book-card';
                bookCard.style.cursor = 'pointer';
                bookCard.innerHTML = `
                    <img src="${book.cover_image || '/FrontEnd/images/book-cover.png'}" alt="${book.title}">
                    <p class="title">${book.title}</p>
                    <p class="sub">${book.author}</p>
                `;
                bookCard.addEventListener('click', async () => {
                    await trackBookView(book.book_id);
                    window.location.href = `/FrontEnd/public-book-detail.html?id=${book.book_id}`;
                });
                
                container.appendChild(bookCard);
            });
        }

        async function loadPopularBooks() {
            try {
                const response = await fetch(`${API_URL}/books/popular`);
                if (!response.ok) throw new Error('Failed to fetch popular books');
                
                const books = await response.json();
                const slider = document.getElementById('popular-books-slider');
                
                if (!slider) return;
                
                slider.innerHTML = '';
                
                books.forEach(book => {
                    const bookCard = document.createElement('div');
                    bookCard.className = 'book-card';
                    bookCard.style.cursor = 'pointer';
                    bookCard.innerHTML = `
                        <img src="${book.cover_image || '/FrontEnd/images/book-cover.png'}" alt="${book.title}">
                        <p class="title">${book.title}</p>
                        <p class="sub">${book.author}</p>
                    `;
                    bookCard.addEventListener('click', async () => {
                        await trackBookView(book.book_id);
                        window.location.href = `/FrontEnd/public-book-detail.html?id=${book.book_id}`;
                    });
                    slider.appendChild(bookCard);
                });
            } catch (error) {
                console.error('Error loading popular books:', error);
            }
        }

        async function loadTopBorrowedBooks() {
            try {
                const response = await fetch(`${API_URL}/books/top-borrowed`);
                if (!response.ok) throw new Error('Failed to fetch top borrowed books');
                
                const books = await response.json();
                const slider = document.getElementById('top-borrowed-slider');
                
                if (!slider) return;
                
                slider.innerHTML = '';
                
                books.forEach(book => {
                    const bookCard = document.createElement('div');
                    bookCard.className = 'book-card';
                    bookCard.style.cursor = 'pointer';
                    bookCard.innerHTML = `
                        <img src="${book.cover_image || '/FrontEnd/images/book-cover.png'}" alt="${book.title}">
                        <p class="title">${book.title}</p>
                        <p class="sub">${book.author}</p>
                    `;
                    bookCard.addEventListener('click', async () => {
                        await trackBookView(book.book_id);
                        window.location.href = `/FrontEnd/public-book-detail.html?id=${book.book_id}`;
                    });
                    slider.appendChild(bookCard);
                });
            } catch (error) {
                console.error('Error loading top borrowed books:', error);
            }
        }

        async function showCategoryBooks(categoryId, categoryName) {
            window.location.href = `/FrontEnd/category-books.html?id=${categoryId}&name=${encodeURIComponent(categoryName)}`;
        }

        async function loadCategories() {
            try {
                const response = await fetch(`${API_URL}/categories`);
                if (!response.ok) {
                    throw new Error(`Failed to fetch categories: ${response.status}`);
                }
                const categories = await response.json();
                const categoryList = document.getElementById('categoryList');
                if (!categoryList) {
                    console.error('Category list element not found');
                    return;
                }
                
                categoryList.innerHTML = '';
                
                const categoryIcons = {
                    'Romance': 'ðŸ’•',
                    'Fantasy': 'âœ¨',
                    'Horror': 'ðŸ˜±',
                    'Drama': 'ðŸŽ­',
                    'Sci-Fi': 'ðŸš€',
                    'Thriller': 'ðŸ”',
                    'Mystery': 'ðŸ•µï¸',
                    'Biography': 'ðŸ“–',
                    'History': 'ðŸ“š',
                    'Self-Help': 'ðŸ’¡',
                    'Children\'s Book': 'ðŸ‘¶',
                    'Memoir': 'âœï¸'
                };
                
                categories.forEach(category => {
                    const card = document.createElement('div');
                    card.className = 'kategori-card';
                    card.style.cursor = 'pointer';
                    card.style.position = 'relative';
                    card.style.zIndex = '10';
                    
                    const icon = document.createElement('div');
                    icon.className = 'kategori-icon';
                    icon.textContent = categoryIcons[category.category_name] || 'ðŸ“š';
                    
                    const title = document.createElement('p');
                    title.className = 'kategori-title';
                    title.textContent = category.category_name;
                    
                    card.appendChild(icon);
                    card.appendChild(title);
                    
                    card.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        showCategoryBooks(category.category_id, category.category_name);
                    };
                    
                    categoryList.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        function displayBooksInGrid(books, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = '';
            
            books.forEach(book => {
                const bookCard = document.createElement('div');
                bookCard.className = 'book-card-large';
                
                const coverImage = book.cover_image || '/FrontEnd/images/book-cover.png';
                
                bookCard.innerHTML = `
                    <img src="${coverImage}" alt="${book.title}" onerror="this.src='/FrontEnd/images/book-cover.png'">
                    <p class="title">${book.title}</p>
                    <p class="sub">${book.author}</p>
                `;
                
                container.appendChild(bookCard);
            });
        }

        let map = null;
        let userMarker = null;
        let userLocation = { lat: -6.9175, lng: 107.6191 }; // Default to Bandung

        function initMap() {
            if (map) return; // Already initialized
            
            map = L.map('map').setView([userLocation.lat, userLocation.lng], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            userMarker = L.marker([userLocation.lat, userLocation.lng], {
                icon: L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                })
            }).addTo(map).bindPopup('Your Location').openPopup();
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        map.setView([userLocation.lat, userLocation.lng], 13);
                        userMarker.setLatLng([userLocation.lat, userLocation.lng]);
                        document.getElementById('userLocationText').textContent = 
                            `Your Location: ${userLocation.lat.toFixed(4)}, ${userLocation.lng.toFixed(4)}`;
                        loadLocations();
                    },
                    (error) => {
                        console.error('Error getting location:', error);
                        document.getElementById('userLocationText').textContent = 
                            'Using default location (Bandung)';
                        loadLocations();
                    }
                );
            } else {
                document.getElementById('userLocationText').textContent = 
                    'Geolocation not supported. Using default location (Bandung)';
                loadLocations();
            }
        }
        
        function loadLocations() {
            const locations = [
                {
                    name: 'LibMatch Transmart Buahbatu',
                    lat: -6.9667222,
                    lng: 107.6393889,
                    address: 'Jl. Soekarno Hatta No.713, Sekejati, Kec. Buahbatu, Bandung'
                },
                {
                    name: 'LibMatch Kebon Jati',
                    lat: -6.9160556,
                    lng: 107.5951944,
                    address: 'Jl. Kebon Jati, Bandung Wetan, Kec. Bandung Wetan, Bandung'
                },
                {
                    name: 'LibMatch Cihampelas',
                    lat: -6.8921389,
                    lng: 107.6041944,
                    address: 'Jl. Cihampelas, Tamansari, Kec. Bandung Wetan, Bandung'
                }
            ];
            
            displayLocations(locations);
        }
        
        function displayLocations(locations) {
            const container = document.getElementById('locationsContainer');
            container.innerHTML = '';
            
            locations.forEach(location => {
                const marker = L.marker([location.lat, location.lng], {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    })
                }).addTo(map);
                
                const distance = calculateDistance(
                    userLocation.lat, userLocation.lng, location.lat, location.lng
                ).toFixed(1);
                
                marker.bindPopup(`
                    <strong>${location.name}</strong><br>
                    ${location.address}<br>
                    <small>${distance} km from you</small>
                `);
                
                const card = document.createElement('div');
                card.className = 'store-card';
                card.style.cursor = 'pointer';
                card.innerHTML = `
                    <h4>${location.name}</h4>
                    <p>${location.address}</p>
                    <p class="distance">${distance} km from your location</p>
                `;
                
                card.addEventListener('click', () => {
                    map.setView([location.lat, location.lng], 15);
                    marker.openPopup();
                });
                
                container.appendChild(card);
            });
        }
        
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        const originalShowFeature = window.showFeature;
        window.showFeature = function(featureName) {
            console.log('[v0] Switching to feature:', featureName);
            originalShowFeature(featureName);
            
            if (featureName === 'kategori') {
                setTimeout(() => {
                    loadCategories();
                }, 100);
            }
            
            if (featureName === 'find-store') {
                setTimeout(() => {
                    initMap();
                }, 100);
            }
            
            if (featureName === 'bestseller') {
                loadBestsellerBooks();
            }
        };

        async function loadBestsellerBooks() {
            console.log('[v0] Loading bestseller books');
            try {
                const response = await fetch(`${API_URL}/books/popular`);
                if (!response.ok) throw new Error('Failed to fetch bestseller books');
                
                const books = await response.json();
                console.log('[v0] Loaded', books.length, 'bestseller books');
                displayBooksInGrid(books.slice(0, 20), 'bestseller-grid');
            } catch (error) {
                console.error('Error loading bestseller books:', error);
            }
        }

        async function trackBookView(bookId) {
            console.log('[v0] Tracking view for book ID:', bookId);
            try {
                const response = await fetch(`${API_URL}/books/${bookId}/view`, { method: 'POST' });
                console.log('[v0] View tracked successfully:', response.status);
            } catch (error) {
                console.error('[v0] Error tracking view:', error);
            }
        }
    </script>
</body>
</html>
